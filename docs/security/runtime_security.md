# Cylestio Monitor Runtime Security

Cylestio Monitor provides comprehensive runtime security monitoring for AI agents. This document outlines the process execution and network connection monitoring features designed to detect potential security threats, such as remote code execution (RCE) attempts, command and control (C2) channels, and data exfiltration.

## Runtime Security Monitoring

The runtime security monitoring consists of two main components:

1. **Process Execution Monitoring**: Detects and logs suspicious process spawns that may indicate RCE attempts
2. **Network Connection Monitoring**: Detects and logs suspicious network connections that may indicate C2 or data exfiltration

### Process Execution Monitoring

The process monitoring system intercepts and analyzes system calls to detect potentially dangerous process execution patterns. This monitoring:

- Intercepts all `subprocess.Popen` and `os.system` calls
- Analyzes process command lines for dangerous patterns
- Detects shell command injections and escapes
- Logs detailed process execution context
- Generates security alerts for high-risk activities

Process execution events are logged with detailed context to facilitate forensic investigation:

```json
{
  "timestamp": "2023-04-25T10:15:32.438Z",
  "name": "process.exec",
  "attributes": {
    "proc.path": "/bin/bash",
    "proc.args": "-c 'cat /etc/passwd'",
    "proc.shell": true,
    "proc.calling_context": "database.py:102:execute_query",
    "security.category": "process_execution",
    "security.severity": "high"
  }
}
```

### Network Connection Monitoring

The network monitoring system intercepts and analyzes outbound network connections to detect potential C2 channels or data exfiltration attempts:

- Monitors all socket connections
- Analyzes connection destinations and ports
- Detects connections to known malicious ports
- Flags direct IP connections vs domain names
- Generates security alerts for suspicious connections
- Automatically filters out the monitor's own telemetry connections

Network connection events are logged with detailed context:

```json
{
  "timestamp": "2023-04-25T10:17:45.712Z",
  "name": "net.conn_open",
  "attributes": {
    "net.transport": "tcp",
    "net.dst.ip": "192.168.1.100",
    "net.dst.port": 4444,
    "net.is_local": false,
    "security.category": "potential_c2",
    "security.severity": "critical"
  }
}
```

### Self-Monitoring Prevention

To prevent the monitor from monitoring itself and creating noise in the logs, connections to the telemetry endpoint are automatically filtered out. This includes:

- Connections to the configured telemetry endpoint host and port
- Standard HTTP/HTTPS ports (80/443) for the same host
- Localhost equivalents when using a local endpoint

The telemetry endpoint is determined from these sources (in order of precedence):
1. The `CYLESTIO_TELEMETRY_ENDPOINT` environment variable
2. The `telemetry_endpoint` configuration setting
3. Default fallback to `http://127.0.0.1:8000`

## Security Classifications

Both the process and network monitoring systems classify security events based on severity:

- **Critical**: Immediate security threat requiring attention
- **High**: Suspicious activity that likely indicates a security issue
- **Medium**: Potentially suspicious activity that warrants investigation
- **Low**: Normal or expected activity with low security risk

## Configuration

Runtime security monitoring can be configured when starting the monitoring:

```python
import cylestio_monitor

cylestio_monitor.start_monitoring(
    agent_id="my-agent",
    config={
        "enable_rce_detection": True,     # Process execution monitoring
        "enable_network_detection": True, # Network connection monitoring
        "security_sensitivity": "medium"  # Sensitivity level (low, medium, high)
    }
)
```

## Integration with Security Tools

The security events generated by Cylestio Monitor can be integrated with:

- **SIEM Systems**: Through JSON logs or OpenTelemetry exporters
- **Security Dashboards**: Through the Cylestio UI or custom dashboards
- **Alert Management**: Through configurable alert thresholds and notification channels
- **Incident Response**: Through detailed forensic data in security events

## Best Practices

For optimal security monitoring:

1. **Enable both monitoring types** for comprehensive coverage
2. **Configure appropriate sensitivity** based on your environment
3. **Review security logs regularly** for suspicious patterns
4. **Establish incident response procedures** for critical alerts
5. **Update the monitor regularly** to get the latest security rules
